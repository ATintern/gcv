'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var GCV=GCV||{};GCV.merge=function(data){var tracks=$.extend(true,{},data);var groups={};for(var i=1;i<tracks.groups.length;i++){var track=tracks.groups[i];groups[track.id]=groups[track.id]||[];groups[track.id].push(track)}tracks.groups=[tracks.groups[0]];for(var i in groups){if(!groups.hasOwnProperty(i)){continue}var groupTracks=groups[i],merged=[];for(var j=0;j<groupTracks.length;j++){if(merged.indexOf(j)!=-1){continue}var jTrack=groupTracks[j],jIds=jTrack.genes.map(function(g){return g.id});for(var k=j+1;k<groupTracks.length;k++){if(merged.indexOf(k)!=-1){continue}var kTrack=groupTracks[k],kIds=kTrack.genes.map(function(g){return g.id});var overlap=jIds.filter(function(id){return kIds.indexOf(id)!=-1});if(overlap.length>0){if(kIds.length>jIds.length){var indices=overlap.map(function(id){return kIds.indexOf(id)});var min=Math.min.apply(null,indices),max=Math.max.apply(null,indices);var startGene=kTrack.genes[min],endGene=kTrack.genes[max];var score=endGene.suffixScore-startGene.suffixScore;if(jTrack.score>score){merged.push(j);var args=[min,max-min+1],geneArgs=args.concat(jTrack.genes);Array.prototype.splice.apply(kTrack.genes,geneArgs);var pred=min>0?kTrack.genes[min-1].suffixScore:0;for(var l=min;l<=max;l++){kTrack.genes[l].suffixScore+=pred;kTrack.genes[l].y=kTrack.levels}var adjustment=jTrack.score-score;for(var l=max+1;l<kTrack.genes.length;l++){kTrack.genes[l].suffixScore+=adjustment}kTrack.score+=adjustment;kTrack.levels++;break}}else if(jIds.length==kIds.length){var indices=overlap.map(function(id){return jIds.indexOf(id)});var min=Math.min.apply(null,indices),max=Math.max.apply(null,indices);var startGene=jTrack.genes[min],endGene=jTrack.genes[max];var score=endGene.suffixScore-startGene.suffixScore;if(kTrack.score>score){merged.push(k);var args=[min,max-min+1],geneArgs=args.concat(kTrack.genes),idArgs=args.concat(kIds);Array.prototype.splice.apply(jTrack.genes,geneArgs);Array.prototype.splice.apply(jIds,idArgs);var pred=min>0?jTrack.genes[min-1].suffixScore:0;for(var l=min;l<=max;l++){jTrack.genes[l].suffixScore+=pred;jTrack.genes[l].y=jTrack.levels}var adjustment=kTrack.score-score;for(var l=max+1;l<jTrack.genes.length;l++){jTrack.genes[l].suffixScore+=adjustment}jTrack.score+=adjustment;jTrack.levels++}}}}if(merged.indexOf(j)==-1){tracks.groups.push(jTrack)}}}return tracks};GCV.Viewer=function(){_createClass(_class2,[{key:'_autoResize',value:function _autoResize(el,f){var iframe=document.createElement('IFRAME');iframe.setAttribute('allowtransparency',true);iframe.className='GCV-resizer';el.appendChild(iframe);iframe.contentWindow.onresize=function(){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(f,10)};return iframe}},{key:'_beginHover',value:function _beginHover(selection){d3.selectAll('.GCV').classed('hovering',true);selection.classed('active',true)}},{key:'_endHover',value:function _endHover(selection){selection.classed('active',false);clearTimeout(this._hoverTimeout);this._hoverTimeout=setTimeout(function(){clearTimeout(this._hoverTimeout);this._hoverTimeout=undefined;if(d3.selectAll('.GCV .active').empty()){d3.selectAll('.GCV').classed('hovering',false)}},125)}},{key:'_resize',value:function _resize(){var w=this.container.clientWidth,doublePad=2*this._PAD,halfGlyph=this._GLYPH_SIZE/2,r1=this.left+halfGlyph,r2=w-(this.right+halfGlyph);this.viewer.attr('width',w);this.x.range([r1,r2])}},{key:'_decorateResize',value:function _decorateResize(d){this._resize=function(resize){resize();d()}.bind(this,this._resize)}},{key:'_init',value:function _init(id,colors,data,options){this.container=document.getElementById(id);if(this.container===null){throw new Error('"'+id+'" is not a valid element ID')}this.colors=colors;if(this.colors===undefined){throw new Error('"color" is undefined')}this.data=data;if(this.data===undefined){throw new Error('"data" is undefined')}var numLevels=this.data.groups.reduce(function(sum,g){return sum+g.levels},0),halfTrack=this._GLYPH_SIZE/2,top=this._PAD+halfTrack,bottom=top+this._GLYPH_SIZE*numLevels;this.viewer=d3.select('#'+id).append('svg').attr('class','GCV').attr('height',bottom+halfTrack);var minX=Infinity,maxX=-Infinity;this.ticks=[];this.names=[];var tick=0;for(var i=0;i<data.groups.length;i++){var group=data.groups[i],min=Infinity,max=-Infinity;this.ticks.push(tick);tick+=group.levels;for(var j=0;j<group.genes.length;j++){var gene=group.genes[j],fmax=gene.fmax,fmin=gene.fmin,x=gene.x;min=Math.min.apply(null,[min,fmax,fmin]);max=Math.max.apply(null,[max,fmax,fmin]);minX=Math.min(minX,x);maxX=Math.max(maxX,x)}this.names.push(group.chromosome_name+':'+min+'-'+max)}this.x=d3.scale.linear().domain([minX,maxX]);this.y=d3.scale.linear().domain([0,numLevels-1]).range([top,bottom]);this.options=options||{};this.options.focus=options.focus;this.options.selectiveColoring=options.selectiveColoring;this.options.nameClick=options.nameClick||function(y,i){};this.options.geneClick=options.geneClick||function(b){};this.options.plotClick=options.plotClick;this.options.autoResize=options.autoResize||false;this.right=this._PAD;this._resize=this._resize.bind(this)}},{key:'_drawTrack',value:function _drawTrack(i){var obj=this,t=this.data.groups[i],y=this.ticks[i];var selector='micro-'+i.toString(),track=this.viewer.append('g').attr('class',selector),geneGroups=track.selectAll('gene').data(t.genes).enter().append('g').attr('class','gene').attr('transform',function(g){return'translate('+obj.x(g.x)+', '+obj.y(y+g.y)+')'}).style('cursor','pointer').on('mouseover',function(g){obj._beginHover(d3.select(this))}).on('mouseout',function(g){obj._endHover(d3.select(this))}).on('click',obj.options.geneClick);var genes=geneGroups.append('path').attr('d',d3.svg.symbol().type('triangle-up').size(200)).attr('class',function(g){if(obj.options.focus!==undefined&&(obj.options.focus==g.family||obj.options.focus==g.name)){return'point focus'}else if(g.family==''){return'point no_fam'}else if(obj.options.selectiveColoring!==undefined&&obj.options.selectiveColoring[g.family]==1){return'point single'}return'point'}).attr('transform',function(g){var orientation=g.strand==1?'90':'-90';return'rotate('+orientation+')'}).style('fill',function(g){if(g.family==''||obj.options.selectiveColoring!==undefined&&obj.options.selectiveColoring[g.family]==1){return'#ffffff'}return obj.colors(g.family)});var tips=geneGroups.append('text').attr('class','synteny-tip').attr('text-anchor','end').text(function(g){return g.name+': '+g.fmin+' - '+g.fmax});track.resize=function(genesGroups,tips){var obj=this;geneGroups.attr('transform',function(g){return'translate('+obj.x(g.x)+', '+obj.y(y+g.y)+')'})}.bind(this,geneGroups,tips);track.rotateTips=function(tips,resize){var vRect=obj.viewer.node().getBoundingClientRect();tips.classed('synteny-tip',false).attr('transform',function(t){var tRect=this.getBoundingClientRect(),h=Math.sqrt(Math.pow(tRect.width,2)/2),r=tRect.bottom+h>vRect.bottom?45:-45;return'rotate('+r+')'}).classed('synteny-tip',true);resize()}.bind(this,tips,track.resize);return track}},{key:'_drawYAxis',value:function _drawYAxis(){var _this=this;var axis=d3.svg.axis().scale(this.y).orient('left').tickValues(this.ticks).tickFormat(function(y,i){return _this.names[i]});var yAxis=this.viewer.append('g').attr('class','axis').call(axis);yAxis.selectAll('text').attr('class',function(y,i){var c=i==0?'query ':'';return c+'micro-'+i.toString()}).style('cursor','pointer').on('mouseover',function(y,i){var selection=d3.selectAll('.GCV .micro-'+i.toString());_this._beginHover(selection)}).on('mouseout',function(y,i){var selection=d3.selectAll('.GCV .micro-'+i.toString());_this._endHover(selection)}).on('click',this.options.nameClick);return yAxis}},{key:'_drawPlotAxis',value:function _drawPlotAxis(){var axis=d3.svg.axis().scale(this.y).orient('right').tickValues(this.ticks).tickFormat('plot');var plotYAxis=this.viewer.append('g').attr('class','axis').call(axis);plotYAxis.selectAll('text').style('cursor','pointer').on('click',this.options.plotClick);return plotYAxis}},{key:'_draw',value:function _draw(){var _this2=this;var yAxis=this._drawYAxis();this.left=yAxis.node().getBBox().width+this._PAD;yAxis.attr('transform','translate('+this.left+', 0)');this.left+=this._PAD;if(this.options.plotClick){var plotAxis=this._drawPlotAxis();this.right+=plotAxis.node().getBBox().width+this._PAD;var obj=this;var resizePlotYAxis=function resizePlotYAxis(){var x=obj.viewer.attr('width')-obj.right+obj._PAD;plotAxis.attr('transform','translate('+x+', 0)')};this._decorateResize(resizePlotYAxis)}this._resize();var tracks=[];for(var i=0;i<this.data.groups.length;i++){tracks.push(this._drawTrack(i))}var resizeTracks=function resizeTracks(){tracks.forEach(function(t,i){t.resize()})};this._decorateResize(resizeTracks);tracks.forEach(function(t,i){t.rotateTips()});this.viewer.selectAll('.synteny-tip').moveToFront();if(this.options.autoResize){this.resizer=this._autoResize(this.container,function(e){_this2._resize()})}}}]);function _class2(id,colors,data,options){_classCallCheck(this,_class2);this._PAD=5;this._GLYPH_SIZE=30;this._hoverTimeout=0;this._init(id,colors,data,options);this._draw()}_createClass(_class2,[{key:'destroy',value:function destroy(){if(this.container){this.container.removeChild(this.viewer.node());if(this.resizer){this.container.removeChild(this.resizer)}}this.container=this.viewer=this.resizer=undefined}}]);return _class2}();

